name: Deploy / Build

# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –†–£–ù–ê (–≤–∏–¥–Ω–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ Actions –∏ –≤ –ø–æ–∏—Å–∫–µ)
run-name: "Run: env=${{ github.event.inputs.environment || 'n/a' }}, version=${{ github.event.inputs.version || 'n/a' }}"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        default: dev
        type: choice
        options: [dev, prod]
      version:
        description: App version
        required: false
        default: ""
      deploy:
        description: Deploy after build?
        required: true
        type: choice
        default: no
        options: [yes, no]

jobs:
  build:
    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–º—è job‚Äô–∞ ‚Äî —Ç–æ–∂–µ –≤–∏–¥–Ω–æ –≤ UI
    name: "Build & Report (env=${{ github.event.inputs.environment || 'n/a' }})"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Annotation: –±—Ä–æ—Å–∞–µ–º –∑–∞–º–µ—Ç–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å inputs
      - name: Emit inputs as annotation
        run: |
          echo "::notice title=Workflow Inputs::environment=${{ github.event.inputs.environment }}, version=${{ github.event.inputs.version }}, deploy=${{ github.event.inputs.deploy }}"

      # 2) Summary: –æ–¥–Ω–∞ –æ–±—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—É—Å–∫–∞
      - name: Write Inputs & Context to Summary
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          {
            echo "## üìã Run Summary"
            echo ""
            echo "| Key | Value |"
            echo "|---|---|"
            echo "| Environment | ${{ github.event.inputs.environment }} |"
            echo "| Version | ${{ github.event.inputs.version }} |"
            echo "| Deploy | ${{ github.event.inputs.deploy }} |"
            echo "| Branch | ${{ github.ref_name }} |"
            echo "| Commit | ${SHORT_SHA} |"
            echo "| Actor | ${{ github.actor }} |"
            echo "| Event | ${{ github.event_name }} |"
            echo "| Run # | ${{ github.run_number }} |"
            echo ""
            echo "<details><summary>All inputs (JSON)</summary>"
            echo ""
            echo '```json'
            echo '${{ toJson(github.event.inputs) }}'
            echo '```'
            echo "</details>"
          } >> $GITHUB_STEP_SUMMARY

      # 3) Artifact: —Å–æ—Ö—Ä–∞–Ω—è–µ–º inputs –≤ —Ñ–∞–π–ª –∏ –ø—É–±–ª–∏–∫—É–µ–º
      - name: Create inputs.json
        run: |
          cat > inputs.json <<'JSON'
          ${{ toJson(github.event.inputs) }}
          JSON

      - name: Upload inputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: workflow-inputs
          path: inputs.json

      # (–¥–µ–º–æ) –£—Å–ª–æ–≤–Ω—ã–π —à–∞–≥ –ø–æ input
      - name: Deploy step (only if deploy=yes)
        if: ${{ github.event.inputs.deploy == 'yes' }}
        run: echo "Deploying to ${{ github.event.inputs.environment }}..."

      - name: Skip deploy (deploy=no)
        if: ${{ github.event.inputs.deploy != 'yes' }}
        run: echo "Skipping deploy."